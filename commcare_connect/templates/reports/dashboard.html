{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% load django_tables2 %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}
<h2 class="my-2">Program Dashboard</h2>
<div class="container" x-data="dashboardStats()" >
  <div class="mb-4">
    <div class="row mb-4" x-ref="filterForm" id="filterForm">
      {% crispy filter.form %}
    </div>
  </div>
  <div class="row">
    <div class="col-12 col-sm-6 col-md-3 mb-3">
      <div class="card">
        <div class="card-body">
          <div class="fw-bold">
            <span x-show="!isLoading" x-text="stats.active_users || 0" class="display-4">0</span>
            <span x-show="isLoading">
              <span class="spinner-border text-secondary opacity-50" role="status"></span>
              <span class="display-4">&nbsp;</span>
            </span>
          </div>
          <div class="small text-muted mt-1">Active FLWs</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-md-3 mb-3">
      <div class="card">
        <div class="card-body">
          <div class="fw-bold">
            <span x-show="!isLoading" x-text="stats.total_visits || 0" class="display-4">0</span>
            <span x-show="isLoading">
              <span class="spinner-border text-secondary opacity-50" role="status"></span>
              <span class="display-4">&nbsp;</span>
            </span>
          </div>
          <div class="small text-muted mt-1">Total Visits</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-md-3 mb-3">
      <div class="card">
        <div class="card-body">
          <div class="fw-bold">
            <span x-show="!isLoading" x-text="stats.verified_visits || 0" class="display-4">0</span>
            <span x-show="isLoading">
              <span class="spinner-border text-secondary opacity-50" role="status"></span>
              <span class="display-4">&nbsp;</span>
            </span>
          </div>
          <div class="small text-muted mt-1">Verified Visits</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-md-3 mb-3">
      <div class="card">
        <div class="card-body">
          <div class="fw-bold">
            <span x-show="!isLoading" x-text="stats.percent_verified || '0.0%'" class="display-4">0</span>
            <span x-show="isLoading">
              <span class="spinner-border text-secondary opacity-50" role="status"></span>
              <span class="display-4">&nbsp;</span>
            </span>
          </div>
          <div class="small text-muted mt-1">Percent Verified</div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="row">
  <div class="col-12">
    <h3 class="my-2">Service Delivery Map</h3>
    <div id="map" class="mt-3 mb-2 rounded border" style="height: 900px;"></div>
  </div>
</div>
{% endblock content %}
{% block inline_javascript %}
{{ block.super }}
<script>
  function dashboardStats() {
    return {
      stats: {
        total_visits: 0,
        active_users: 0,
        verified_visits: 0,
        percent_verified: "0.0%"
      },
      isLoading: false,
      async init() {
        await this.loadStats();
        const formElement = this.$refs.filterForm.querySelector('form');
        formElement.querySelectorAll('select, input').forEach(input => {
          if (input.value) {
            input.dispatchEvent(new Event('change'));
          }
          input.addEventListener('change', () => {
            this.loadStats();
            window.refreshMapData();
          });
        });
      },
      async loadStats(event) {
        try {
          this.isLoading = true;
          const formElement = this.$refs.filterForm.querySelector('form');
          const formData = new FormData(formElement);
          const queryString = new URLSearchParams(formData).toString();
          const url = `{% url 'reports:dashboard_stats_api' %}?${queryString}`;
          const response = await fetch(url);
          if (!response.ok) throw new Error('Failed to load stats');
          const data = await response.json();
          this.stats = data;
        } catch (error) {
          console.error('Error loading dashboard stats:', error);
        } finally {
          this.isLoading = false;
        }
      }
    }
  }
</script>
<script type="module">
  let map;

  // Add this function to handle map data refresh
  window.refreshMapData = () => {
    if (!map) return;

    const formElement = document.querySelector('#filterForm form');
    const formData = new FormData(formElement);
    const queryString = new URLSearchParams(formData).toString();

    // Update the source data with new filters
    map.getSource('visits').setData(`{% url "reports:visit_map_data" %}?${queryString}`);
  };

  window.addEventListener('DOMContentLoaded', () => {
    mapboxgl.accessToken = "{{ mapbox_token }}";
    const cluster = {% if cluster_visits %}true{% else %}false{% endif %};
    map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/dark-v11',
      center: [20, 0], // Centered on Africa (roughly central coordinates)
      zoom: 3,
    });

    map.on('load', () => {
      // Modify the source configuration to include initial filters
      const formElement = document.querySelector('#filterForm form');
      const formData = new FormData(formElement);
      const queryString = new URLSearchParams(formData).toString();

      map.addSource('visits', {
        type: 'geojson',
        data: `{% url "reports:visit_map_data" %}?${queryString}`,
        cluster: cluster,
        clusterMaxZoom: 12,
        clusterRadius: 50
      });

      const clusterStep1 = 50;
      const clusterStep2 = 100;

      map.addLayer({
        id: 'clusters',
        type: 'circle',
        source: 'visits',
        filter: ['has', 'point_count'],
        paint: {
          // Use step expressions (https://docs.mapbox.com/style-spec/reference/expressions/#step)
          // with three steps to implement three types of circles:
          //   * Blue, 20px circles when point count is less than clusterStep1
          //   * Yellow, 30px circles when point count is between clusterStep1 and clusterStep2
          //   * Green, 40px circles when point count is greater than or equal to clusterStep2
          'circle-color': [
            'step',
            ['get', 'point_count'],
            '#51bbd6',
            clusterStep1,
            '#f1f075',
            clusterStep2,
            '#00FF00'
          ],
          'circle-radius': [
            'step',
            ['get', 'point_count'],
            20,
            clusterStep1,
            30,
            clusterStep2,
            40
          ]
        }
      });

      map.addLayer({
        id: 'cluster-count',
        type: 'symbol',
        source: 'visits',
        filter: ['has', 'point_count'],
        layout: {
          'text-field': ['get', 'point_count_abbreviated'],
          'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
          'text-size': 12
        }
      });

      map.addLayer({
        id: 'unclustered-point',
        type: 'circle',
        source: 'visits',
        filter: ['!', ['has', 'point_count']],
        paint: {
          'circle-color': ['get', 'color'],
          'circle-radius': 4,
          'circle-stroke-width': 1,
          'circle-stroke-color': '#fff'
        }
      });

      // inspect a cluster on click
      map.on('click', 'clusters', (e) => {
        const features = map.queryRenderedFeatures(e.point, {
          layers: ['clusters']
        });
        const clusterId = features[0].properties.cluster_id;
        map.getSource('visits').getClusterExpansionZoom(
          clusterId,
          (err, zoom) => {
            if (err) return;

            map.easeTo({
              center: features[0].geometry.coordinates,
              zoom: zoom
            });
          }
        );
      });

      // When a click event occurs on a feature in
      // the unclustered-point layer, open a popup at
      // the location of the feature, with
      // description HTML from its properties.
      map.on('click', 'unclustered-point', (e) => {
        const coordinates = e.features[0].geometry.coordinates.slice();
        const status = e.features[0].properties.status;
        const rawDate = e.features[0].properties.visit_date;
        const visitDate = new Date(rawDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });


        // Ensure that if the map is zoomed out such that
        // multiple copies of the feature are visible, the
        // popup appears over the copy being pointed to.
        if (['mercator', 'equirectangular'].includes(map.getProjection().name)) {
          while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
          }
        }

        new mapboxgl.Popup()
          .setLngLat(coordinates)
          .setHTML(
            `Visit Date: ${visitDate}<br>Status: ${status}`
          )
          .addTo(map);
      });

      map.on('mouseenter', 'clusters', () => {
        map.getCanvas().style.cursor = 'pointer';
      });
      map.on('mouseleave', 'clusters', () => {
        map.getCanvas().style.cursor = '';
      });
    });
  });
</script>
{% endblock %}
